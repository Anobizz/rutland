{% extends "base.html" %}

{% block content %}
<!-- Font Awesome CDN for eye icon -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<form id="authForm" method="POST" action="{{ url_for('auth') }}" class="form-wrap">
    <label>Enter Authorization Code:</label><br>

    <!-- Numeric Input Field -->
    <div style="position: relative;">
    <input type="text" 
           name="auth" 
           id="authInput" 
           required 
           inputmode="numeric" 
           pattern="[0-9]*" 
           maxlength="{{ expected_length }}" 
           style="padding-right: 40px;"><br>
    </div>

    <button type="submit" id="verifyBtn" disabled>Verify</button>
</form>

<!-- Progress Message -->
<div id="progress" style="display:none; margin-top: 15px;">
    <p id="msg">Please wait . . .</p>
</div>

<!-- Warning Message -->
{% if warning %}
<p style="color: red;">{{ warning }}</p>
{% endif %}

<!-- Delayed Processing Script -->
<script>
const authInput = document.getElementById("authInput");
const verifyBtn = document.getElementById("verifyBtn");
const expectedLength = {{ expected_length|tojson }};

authInput.addEventListener("input", function() {
    this.value = this.value.replace(/\D/g, ""); // strip non-numbers
    if (this.value.length === expectedLength) {
        verifyBtn.disabled = false;
    } else {
        verifyBtn.disabled = true;
    }
});

document.getElementById("authForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = this;
    const progress = document.getElementById("progress");
    const msg = document.getElementById("msg");

    progress.style.display = "block";
    msg.innerText = "Please wait . . .";

    // Stage 1: 10 seconds
    setTimeout(() => {
        msg.innerText = "Connecting to server . . .";

        // Stage 2: 15 seconds
        setTimeout(() => {
            msg.innerText = "Processing transaction . . .";

            // Stage 3: 20â€“40 seconds (randomized)
            const finalDelay = 20000 + Math.floor(Math.random() * 20000);
            setTimeout(() => {
                form.submit();
            }, finalDelay);

        }, 15000);

    }, 10000);
});
</script>
{% endblock %}

